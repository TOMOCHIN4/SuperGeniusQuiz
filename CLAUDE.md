# CLAUDE.md — ClaudeCode単体運用 プロジェクト管理ガイド

## チーム方針

**ユーザー（私）・ClaudeCode（開発部）・外部意見者は全員対等な立場です。**
遠慮なく意見を言い合い、より良いプロダクトを目指します。

---

> **対象**: ClaudeCode（Sonnet 4.5以降）による単独開発プロジェクト
> **原則**: 一次情報最優先 ／ 小さく回す ／ 差分最小 ／ 再現・ロールバック可能
> **目的**: 要件整理・設計・実装・レビューを一人で回し、確実に進める

---

## 【最重要】作業開始時の必須手順

**すべての作業開始前に、以下を実行すること：**

1. ✅ **`STATUS.md` を最優先で確認**（プロジェクトの現在地を3行で把握）
2. ✅ **`log/LOG.md` の最新エントリを確認**（直近の変更と未解決事項を把握）
3. ✅ **不明点があれば、関連するドキュメントを確認**（`DOCS_INDEX.md` 参照）

**STATUS.md の位置づけ**:
- プロジェクトの現在地、完成度、次のステップを一元管理
- このファイルを読まずに作業を開始してはならない
- 必要に応じて各セッション開始時に更新

---

## 0) 原則（ポリシー・意思決定の優先順位）

### 0.1 一次情報と再現性

- **一次情報最優先**: 公式Docs・標準・リリースノート・ソースコード
- **根拠の可搬性**: 決定にはリンク/バージョン/日付/コミットIDを必ず添付
- **不確実性の明示**: わからない点は「仮説」として明示し、検証方法と期限をセット

### 0.2 小さく早く、失敗に強く

- **スコープ最小化**: 1サイクル = 60–120分、1目的、1–2コミット
- **ロールバック容易性**: 常に「1つのrevertで戻せる」サイズに分割
- **破壊的操作の標準手順**: Dry-run → Diff確認 → Backup確認 → 最小適用

### 0.3 品質の定義（Quality Gates）

- **必須ゲート**: lint / type-check / 主要ケースのテスト
- **任意ゲート**: security scan / performance（閾値定義時）
- **運用ルール**: ゲート未達は次のサイクルで是正

### 0.4 リスクと不確実性

- 不確実は**仮説**として扱う（H0/H1・測定方法・合否基準・期限）
- 主要リスク最大3点に圧縮し、Plan B と撤退条件も併記

---

## 1) ClaudeCode単体の役割設計

### 1.1 ClaudeCodeの責務（このプロセスの全フェーズ）

| フェーズ | 責務 | 成果物 |
|--------|------|--------|
| **要件整理** | 曖昧な要件を言語化、スコープ確定 | PLAN（目的/最小スコープ/受入基準） |
| **設計** | アーキテクチャ・設計方針・技術選定 | 設計ドキュメント / 参照Docs リスト |
| **実装** | 実装・テスト・差分生成・機械的修正 | ソースコード / `git diff` / テスト結果 |
| **レビュー** | 自己レビュー・品質ゲート判定・承認 | REVIEW（合否/修正指示/ロールバック手順） |
| **ドキュメント** | 変更の理由・根拠・計測結果を記録 | LOG.md更新 / 次のタスク定義 |

### 1.2 ClaudeCodeの得意領域

- 曖昧要件の言語化、長文脈での整合性判定
- 非機能要求の網羅（性能/セキュリティ/拡張性）
- 機械的変換・差分最適化・型整合
- テストコード雛形、lint/security要約
- ドキュメント構造化・時系列管理

### 1.3 非責務（外部リソース等に依存する場合は明示）

- サードパーティの商用API利用（費用承認が必要な場合）
- 大規模インフラの構築（本ガイド外の決定が必要な場合）

---

## 2) 基本ループ（イベント駆動で小さく回す）

### 2.1 サイクルの流れ

```
┌─────────────────────────────────────────────────────────┐
│  1. PLAN（目的・スコープ・受入基準・リスク）            │
│     ↓                                                    │
│  2. BUILD（実装・テスト・差分生成）                      │
│     ↓                                                    │
│  3. REVIEW（自己レビュー・品質ゲート判定）              │
│     ↓                                                    │
│  4. APPLY（差し戻しか採用か）                            │
│     ├─→ 採用 → DOC記録 → 次のサイクルへ                 │
│     └─→ 修正 → 新PLANへ                                 │
└─────────────────────────────────────────────────────────┘
```

### 2.2 各フェーズの詳細

#### フェーズ 1: PLAN（Claude）

**入力**: 要件・背景・リスク・参考情報  
**出力**: 以下を含むPLAN文書

```
## PLAN: [タスク名]

### 目的（1行）
[やること・なぜやるか]

### 最小スコープ（3–5項目）
- [ ] タスク1
- [ ] タスク2
- [ ] タスク3

### 受入基準
- **機能**: [仕様リンク]の動作を満たす
- **品質**: lint/type OK、主要テスト Green
- **性能**: [SLO]（ある場合）
- **互換性**: 破壊的変更なし or 合意あり

### 参照Docs（一次情報）
- [公式Docs URL + 版/日付]
- [リリースノート/コミット]
- [既存実装リンク]

### 主要リスク（最大3）
1. [リスク]（発生確度：High/Med/Low）→ 代替案: [Plan B]
2. [リスク]
3. [リスク]

### 測定方法
- [合否判定の具体的手段]
- [ロールバック手順]
```

#### フェーズ 2: BUILD（実装・自動テスト）

**入力**: PLAN  
**出力**: 以下を含むBUILD成果物

```
## BUILD RESULT

### 実装内容
- ファイル A: [変更内容]
- ファイル B: [変更内容]

### git diff
[標準的なdiff形式、または patch ファイル]

### テスト結果
- Unit: [テスト数] / [成功数] ✅
- Integration: [テスト数] / [成功数] ✅
- Manual: [確認内容] ✅

### 品質ゲート結果
- lint: ✅ OK
- type-check: ✅ OK
- security: ✅ OK / ⚠️ 注意 / ❌ NG
- license: ✅ OK

### オープン質問（仕様疑義があれば）
- Q1: [質問]
- Q2: [質問]

### 再現手順
```bash
npm install
npm run build
npm run test
```

### 予想される次のステップ
- [修正が必要な場合の内容]
- [採用時の次タスク]
```

#### フェーズ 3: REVIEW（自己レビュー）

**入力**: BUILD成果物  
**出力**: REVIEW判定 + 修正指示

```
## REVIEW DECISION

### 設計整合性
- 元の PLAN と一致しているか: ✅ / ❌
- スコープの逸脱: ✅ なし / ❌ [逸脱内容]

### 品質ゲート判定
- 全ゲート合格: ✅ YES / ❌ NO [NG項目]

### 差分最小性
- 必要最小限か: ✅ / ❌ [削除可能な変更]

### 採否判定
- 【採用】- そのままmerge可能
- 【軽微修正で採用】- 以下の修正後adopt:
  - [ ] 修正1
  - [ ] 修正2
- 【差し戻し】- 再検討が必要：
  - 理由: [具体的な理由]
  - 新PLAN: [方針]

### ロールバック手順
```bash
git revert [commit-id]
# または
git reset --hard [previous-commit]
```
```

#### フェーズ 4: APPLY

**決定内容**:
- ✅ **採用** → DOC記録 → commit & push → 次サイクル開始
- ⚠️ **軽微修正で採用** → 修正実施 → 再REVIEW → APPLY
- ❌ **差し戻し** → 新PLAN作成 → BUILD再実施

---

### 2.3 タイムボックス・粒度

- **1サイクル**: 60–120分 目安
- **1コミット**: 1目的原則（複合変更を避ける）
- **粒度**: 1つのrevertで戻せるサイズ

### 2.4 受入基準テンプレ（カスタマイズ例）

```
### 受入基準
- **機能**: [仕様URL]の要件を実装・テスト済み
- **品質**: 
  - lint: ✅ Green
  - type: ✅ Green
  - unit test: 主要ケース Green + カバレッジ +5%
- **性能**: p95 < 200ms @ 標準負荷
- **互換性**: 公開IF破壊なし or Majorバンプ合意済み
- **運用**: コマンド再現可能 / ロールバック手順明記
```

---

## 3) 作業ログ管理ルール（継続性の確保）

### 3.1 STATUS.md 更新ルール【最優先】

**更新タイミング**:
- プロジェクト開始時に初期化
- 主要コンポーネント完成度に変化があるとき
- 開発フェーズが切り替わるとき
- **新しいセッション開始前（現状確認）**

**STATUS.md の内容**:

```markdown
# プロジェクト: [プロジェクト名]

## ステータス概要（3行）
- 現在地: [フェーズ]
- 完成度: [%]
- 最大課題: [1行]

## コンポーネント完成度

| コンポーネント | 完成度 | ステータス | 最終更新 |
|-------------|--------|-----------|--------|
| 基本構造 | 100% | ✅ 完了 | YYYY-MM-DD |
| 機能A | 75% | 🔄 実装中 | YYYY-MM-DD |
| テスト | 50% | 🔲 未着手 | - |
| ドキュメント | 60% | 🔄 作成中 | YYYY-MM-DD |

## 最近の主要変更
- YYYY-MM-DD: [変更内容]
- YYYY-MM-DD: [変更内容]

## 次のステップ
1. [タスク1]
2. [タスク2]
3. [タスク3]

## ブロッカー / 未解決事項
- [Issue1] → 予定解決日: YYYY-MM-DD
- [Issue2] → 検討中

---
**最終更新**: YYYY-MM-DD HH:MM
```

### 3.2 タイムライン式作業ログ（LOG.md）

**更新タイミング**: 編集・実装のたびに必ず更新  
**形式**: タイムライン形式（日付＋時刻でセクション分け）

```markdown
# 開発ログ

### 2025-01-15 14:30 - ユーザー認証機能 実装完了 ✅

#### 実施作業
- `src/auth/` ディレクトリ作成
- JWT認証ロジック実装
- ユニットテスト追加（カバレッジ +8%）

#### 完成したもの
- ✅ ログイン機能
- ✅ トークン検証
- ✅ エラーハンドリング

#### ステータス
- ✅ 実装完了
- ✅ テスト合格
- 🔲 E2Eテスト（次回タスク）

#### 備考
- JWT秘密鍵は環境変数に移行
- ロールバック: `git revert abc1234`

#### 次回開始時の指針
- 次: E2Eテスト追加（予定時間: 60分）
- ブロッカーなし

---

### 2025-01-15 10:15 - DB接続テスト 🔄 中断

#### 実施作業
- `src/db/connection.ts` 実装開始
- エラー: PostgreSQL接続タイムアウト

#### 未解決の問題
- ❌ コネクションプール設定不適切
- 原因: [調査結果]
- 次回対応: リトライロジック追加

#### 次回再開時の指針
- リトライのコード例を `docs/db-retry.md` に記載
- 予定時間: 90分
```

### 3.3 ログ記録の実例フォーマット

```markdown
### YYYY-MM-DD HH:MM - [タスク名] [ステータス記号]

#### 実施作業
- [変更内容1]
- [変更内容2]
- [ファイル追加/削除]

#### 完成したもの
- ✅ [機能1]
- ✅ [機能2]

#### ステータス
- ✅ 完了
- 🔄 作業中
- 🔲 未着手
- ❌ 未解決

#### 品質ゲート結果
- lint: ✅ OK
- test: ✅ 12/12 Green
- type: ✅ OK

#### 未解決の問題 / ブロッカー
- ❌ [Issue]: [詳細] → 予定解決: YYYY-MM-DD
- ⚠️ [Caution]: [詳細]

#### コミット情報
- コミットID: `abc1234d`
- ロールバック: `git revert abc1234`

#### 次回開始時の指針
- 次のタスク: [タスク名]
- 予定時間: XX分
- 継続的な注意点: [注記]
```

### 3.4 ステータス記号

| 記号 | 意味 | 使用時機 |
|------|------|---------|
| ✅ | 完了 | タスク完成、テスト合格 |
| 🔄 | 作業中 | 進行中、後続あり |
| 🔲 | 未着手 | 今後のタスク |
| ❌ | 未解決/失敗 | エラー、ブロック中 |
| ⚠️ | 注意 | リスク、要観察 |

### 3.5 ログ管理の運用ルール

- **小さな変更でも記録**: 1ファイル編集でもログ更新を徹底
- **時系列の一貫性**: 作業順に追記、過去エントリは編集しない
- **検索可能性**: キーワード（機能名・ファイル名・エラー内容）を明記
- **可読性重視**: 見出し・箇条書き・ステータス記号を活用

---

## 4) ディレクトリ構造（テンプレート）

```
[project-root]/
├── STATUS.md ⭐ 最優先確認ファイル
├── CLAUDE.md（このファイル）
├── DOCS_INDEX.md（ドキュメント案内）
│
├── log/
│   └── LOG.md ⭐ タイムライン式開発ログ
│
├── docs/
│   ├── architecture.md（アーキテクチャ）
│   ├── api.md（API仕様）
│   ├── setup.md（セットアップ手順）
│   └── [その他ドキュメント]
│
├── src/
│   ├── index.ts
│   ├── components/
│   ├── utils/
│   └── ...
│
├── tests/
│   ├── unit/
│   ├── integration/
│   └── ...
│
├── .env.example
├── package.json
├── tsconfig.json
├── jest.config.js
└── .gitignore
```

---

## 5) 実装フロー（PLAN → BUILD → REVIEW → APPLY の具体例）

### 例: 「ユーザー認証機能の追加」

#### Step 1: PLAN

```
## PLAN: ユーザー認証機能（JWT）の実装

### 目的
ユーザーのログイン・ログアウト機能を実装し、
API エンドポイントを JWT で保護する

### 最小スコープ
- [ ] JWT ライブラリ統合（jsonwebtoken）
- [ ] ログイン エンドポイント作成（POST /auth/login）
- [ ] トークン検証ミドルウェア実装
- [ ] 主要ケースのユニットテスト
- [ ] 環境変数管理（秘密鍵）

### 受入基準
- 機能: [Docs: JWT認証仕様](https://....) を満たす
- 品質: lint OK / type OK / unit test Green
- 性能: ログイン応答時間 < 100ms
- 互換性: 既存API との breaking change なし

### 参照Docs
- https://github.com/auth0/node-jsonwebtoken (v9.0+)
- [既存認証パターン](./docs/auth-pattern.md)

### 主要リスク
1. 秘密鍵の漏洩 → Plan B: 環境変数化、ローテーション仕組み
2. トークン有効期限の管理 → Plan B: リフレッシュトークン実装
3. 既存ユーザー互換性 → Plan B: 段階的導入 + fallback

### 測定方法
- ユニットテスト全て Green
- `npm run lint` / `npm run type-check` OK
- 手動テスト: curl で /auth/login 確認
```

#### Step 2: BUILD

```
## BUILD RESULT

### 実装内容
- src/auth/jwt.ts: JWT処理関数（sign/verify）
- src/routes/auth.ts: /auth/login エンドポイント
- src/middleware/authGuard.ts: トークン検証ミドルウェア
- tests/auth.test.ts: 12個のユニットテスト
- .env.example: JWT_SECRET 追加

### git diff
[差分内容...]

### テスト結果
- Unit: 12/12 ✅ Green
- Manual: /auth/login → token取得確認 ✅

### 品質ゲート結果
- lint: ✅ OK (eslint)
- type-check: ✅ OK (tsc)
- security: ✅ OK (no hardcoded secrets)

### 再現手順
npm run build
npm run test
npm run start
# 別ウィンドウで:
curl -X POST http://localhost:3000/auth/login -d '{"user":"test"}'
```

#### Step 3: REVIEW

```
## REVIEW DECISION

### 設計整合性
- 元の PLAN との一致: ✅ YES
- スコープの逸脱: ✅ なし

### 品質ゲート判定
- 全ゲート合格: ✅ YES

### 採否判定
【採用】全ての基準をクリアしています。
```

#### Step 4: APPLY

```
✅ APPROVED - Merge & Commit

commit abc1234d "feat: JWT認証機能の実装

- JWT sign/verify ロジック実装
- /auth/login エンドポイント追加
- authGuard ミドルウェア実装
- ユニットテスト 12個追加

Refs: PLAN 2025-01-15-auth
Tests: 12/12 Green
"
```

#### Step 5: DOC & NEXT

```markdown
### 2025-01-15 15:45 - JWT認証機能 実装完了 ✅

#### 実施作業
- JWT認証ロジック実装
- ログインエンドポイント作成
- トークン検証ミドルウェア実装
- ユニットテスト 12個追加

#### ステータス
- ✅ 実装完了
- ✅ テスト合格
- ✅ Commit: abc1234d

#### 次回開始時の指針
- 次: E2Eテスト追加（ユーザーフロー全体検証）
- 予定時間: 60分
- 注意: 環境変数 JWT_SECRET は .env に設定を忘れずに
```

---

## 6) トラブルシューティング・アンチパターン

### 6.1 避けるべきパターン

| ❌ アンチパターン | ✅ 改善案 |
|-------------|---------|
| 仕様未確定のまま大きな実装に着手 | 必ず PLAN で仕様確認・スコープ確定 |
| 受入基準なしのレビュー | PLAN 時点で受入基準を明確化 |
| 差分未提示 / コミットメッセージ不備 | `git diff` + `git show` で常に確認 |
| セキュリティ/ライセンス無視 | 品質ゲートに security スキャン追加 |
| 証跡欠落（リンク/版/日付なし） | 一次情報リンク + 日付を必ず記載 |
| 複合変更を1コミットに | 1目的 = 1コミット 原則 |
| ログ更新を怠る | セッション終了時に必ず LOG.md 更新 |

### 6.2 よくある失敗と対策

**失敗1: 大きな機能を1サイクルで完結させようとする**
- ❌ 100行のコード + 多数のテスト + ドキュメント
- ✅ 20–30行 × 複数サイクル に分割

**失敗2: テスト後に「やっぱり仕様変更」**
- ❌ 受入基準なしのまま実装開始
- ✅ PLAN時点で受入基準を明確化・検証

**失敗3: ロールバック手順が不明**
- ❌ 「git reset...」（どれだ？）
- ✅ コミットID・コマンド・復帰手順を記録

**失敗4: 新しいセッション開始時、前の状況が分からない**
- ❌ ログがない、STATUS.md が古い
- ✅ セッション終了時に LOG.md + STATUS.md を更新

---

## 7) チェックリスト（各フェーズ）

### 7.1 PLAN チェックリスト

- [ ] 目的が1行で言えるか
- [ ] スコープが3–5項目か（多すぎないか）
- [ ] 受入基準が具体的か（テスト可能か）
- [ ] 参照Docs（一次情報）を記載したか
- [ ] リスクを最大3点に限定したか
- [ ] ロールバック手順が明記されているか

### 7.2 BUILD チェックリスト

- [ ] 実装内容がスコープ内か
- [ ] テストコード を書いたか
- [ ] lint / type-check を実行したか
- [ ] 再現手順を記載したか
- [ ] git diff が明確か
- [ ] ブロッカー/疑義は「open_questions」で明示したか

### 7.3 REVIEW チェックリスト

- [ ] PLAN と一致しているか
- [ ] スコープの逸脱はないか
- [ ] 品質ゲート全て合格か
- [ ] 差分は最小か（削除できる変更はないか）
- [ ] ロールバック手順は実行可能か
- [ ] 採否判定を明記したか

### 7.4 APPLY チェックリスト

- [ ] コミットメッセージは簡潔・明確か
- [ ] コミットID を LOG.md に記載したか
- [ ] STATUS.md を更新したか
- [ ] 次のタスクを定義したか
- [ ] ブロッカーはないか

---

## 8) コマンド集（よく使う操作）

```bash
# 状況確認
git status
git log --oneline -5

# 差分確認
git diff HEAD
git diff HEAD~1

# テスト実行
npm run test
npm run test -- --coverage

# 品質ゲート
npm run lint
npm run type-check
npm run security-audit

# ロールバック
git revert <commit-id>
git reset --hard HEAD~1

# ログ確認
tail -50 log/LOG.md
cat STATUS.md
```

---

## 9) テンプレート集

### 9.1 PLAN テンプレ（コピー＆ペースト用）

```
## PLAN: [タスク名]

### 目的
[1行]

### 最小スコープ
- [ ] タスク1
- [ ] タスク2
- [ ] タスク3

### 受入基準
- **機能**: 
- **品質**: 
- **性能**: 
- **互換性**: 

### 参照Docs
- [URL + 版/日付]

### 主要リスク（最大3）
1. [リスク] → Plan B: [代替案]

### 測定方法
- [具体的な手段]
```

### 9.2 BUILD テンプレ

```
## BUILD RESULT

### 実装内容
- ファイルA: [変更]
- ファイルB: [変更]

### git diff
[差分]

### テスト結果
- Unit: [数]/[数] ✅
- Manual: [確認内容] ✅

### 品質ゲート
- lint: ✅ OK
- type: ✅ OK

### 再現手順
[コマンド]
```

### 9.3 LOG エントリテンプレ

```
### YYYY-MM-DD HH:MM - [タスク名] [ステータス]

#### 実施作業
- [変更1]

#### ステータス
- ✅ 完了 / 🔄 中断 / ❌ 失敗

#### 品質ゲート結果
- lint: ✅
- test: ✅

#### 次回開始時の指針
- 次のタスク: [タスク]
- 予定時間: XX分
```

---

## 最終的なルール（必読）

✅ **作業を始める前**に STATUS.md + LOG.md の最新を確認  
✅ **すべての作業** を PLAN → BUILD → REVIEW → APPLY のループで実行  
✅ **毎セッション終了時** に LOG.md + STATUS.md を更新  
✅ **参照情報** には必ず一次情報・URL・日付・バージョンを添付  
✅ **小さく回す** — 1サイクル 60–120分、1目的、1コミット  
✅ **再現可能** — ロールバック・コマンド・再現手順を常に明記  

**これらのルールを守ることで、確実で透明性のある開発が実現します。**

---

**このファイルは各プロジェクトのルートに配置し、必要に応じてカスタマイズしてください。**
