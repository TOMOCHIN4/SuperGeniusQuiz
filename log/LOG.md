# 開発ログ

---

## 最新: v1.1 参考書ベースシステム（2026-01-02）

### 2026-01-03 11:00 - 正答率表示バグ修正・デプロイ完了 ✅

#### 実施作業
- correct_index を 1-4 → 0-3 形式に修正（GAS側の仕様に合わせる）
- 参考書選択→クイズ遷移時に subject パラメータを追加
- GASコード clasp push & 手動デプロイ
- フロントエンド git push → Vercel自動デプロイ

#### 修正内容
1. **shuffle_json.py**: correct_index を 0-3 で出力するよう修正
2. **BookSelect.tsx**: `/quiz?book_id=...&subject=jp` 形式に変更
3. **GAS get_books**: user_id指定時に正答率を返すよう修正

#### 再登録結果
| 参考書 | 問題数 |
|--------|--------|
| 四字熟語・ことわざ・慣用句 | 459問 |
| 漢字・熟語 書き取り | 1,061問 |
| **合計** | **1,520問** |

---

### 2026-01-03 10:00 - 漢字・熟語参考書 登録完了 ✅

#### 実施作業
- 「中学入試でる順ポケでる国語 漢字・熟語 四訂版」を登録
- merge_json.py にMarkdownエスケープ除去機能を追加（`\_` → `_` 等）

#### 登録結果
```json
{
  "success": true,
  "book_id": "jp_中学入試でる順ポケでる国語 漢字・熟語 四訂版 (書き取り)",
  "question_count": 1061
}
```

#### シャッフル後の正解分布
| 選択肢 | 問題数 | 割合 |
|--------|--------|------|
| 1 | 243問 | 22.9% |
| 2 | 234問 | 22.1% |
| 3 | 300問 | 28.3% |
| 4 | 284問 | 26.8% |

---

### 2026-01-03 09:00 - シャッフル処理追加・再登録完了 ✅

#### 実施作業
- `shuffle_json.py` 作成: 選択肢シャッフル＋correct_index更新
- シャッフル済みデータでAPI再登録

#### 登録結果
```json
{
  "success": true,
  "book_id": "jp_中学入試にでる順 改訂第2版 四字熟語・ことわざ・慣用句",
  "question_count": 431
}
```

#### シャッフル後の正解分布
| 選択肢 | 問題数 | 割合 |
|--------|--------|------|
| 1 | 119問 | 27.6% |
| 2 | 110問 | 25.5% |
| 3 | 105問 | 24.4% |
| 4 | 97問 | 22.5% |

#### 完成したワークフロー
```
参考書PDF
    ↓ LLM（問題生成）
Markdown（複数JSONブロック）
    ↓ merge_json.py
単一JSON
    ↓ shuffle_json.py ← 新規追加
シャッフル済みJSON
    ↓ Python requests
create_book API → スプレッドシート登録
```

---

### 2026-01-03 08:00 - 参考書API登録成功 ✅

#### 実施作業
- Python requestsでcreate_book APIに送信
- 「中学入試にでる順 四字熟語・ことわざ・慣用句」登録完了

#### 技術メモ
- curlはGASのリダイレクトでPOSTデータが失われる
- Python requestsは正常に動作

---

### 2026-01-03 07:30 - 問題データ生成パイプライン構築 ✅

#### 実施作業
- `data/` ディレクトリを参考書データ処理用に整備
- `merge_json.py` 作成: 複数JSONブロック → 単一JSON結合スクリプト
- 「中学入試にでる順 四字熟語・ことわざ・慣用句」の問題データ生成成功

#### 生成結果
- 入力: Markdown内の17個のJSONブロック
- 出力: 459問のクイズデータ（create_book API形式）
- 教科: jp（国語）

#### ワークフロー確立
```
参考書PDF
    ↓ LLM（問題生成）
Markdownファイル（複数JSONブロック）
    ↓ merge_json.py
単一JSON（API送信可能形式）
    ↓ create_book API
スプレッドシートに登録
```

#### 現在のdata/構成
```
data/
├── merge_json.py                                    # 結合スクリプト
├── 中学入試にでる順...四字熟語・ことわざ・慣用句.md   # 元データ
├── 中学入試にでる順...四字熟語・ことわざ・慣用句.json # 結合済み（459問）
└── DATA_TRANSFORM.md                                # 処理説明書
```

---

### 2026-01-02 22:30 - ドキュメント整理 ✅

#### 実施作業
- LLM用プロンプトドキュメント試作 → 削除
  - `知識抽出プロンプト.md`（詳細すぎてAPI形式と不一致）
  - `APIリクエスト生成プロンプト.md`（要件と合わず）
- 既存の `問題生成プロンプト.md` のみ残存

#### 現在のドキュメント構成
```
docs/
├── 参考書登録スキーマ.md  # API仕様書
└── 問題生成プロンプト.md  # LLM用問題生成ガイド
```

---

### 2026-01-02 21:00 - 正答率表示機能 実装 ✅

#### 実施作業
- SubjectCard: 「進捗」→「正答率」にラベル変更
- GAS API: get_booksにuser_id対応、参考書ごとの正答率を返却
- BookSelect: 回答済み参考書に正答率バー表示
- 型定義・APIサービス更新

#### 技術詳細
- Answersシートのgenre_id列からbook_idを集計
- 参考書パターン（`/^(jp|math|sci|soc)_/`）のみ統計対象

#### ドキュメント整理
- `docs/IMPORT_SCHEMA.md` 削除（旧システム用）
- `docs/問題生成プロンプト.md` 新規作成（LLM用システムインストラクション）

---

### 2026-01-02 18:30 - Phase 5 完全完了 ✅

#### 実施作業
- 動作確認完了（Vercel本番環境）
- Questionsシート削除（参考書ベースに完全移行）

#### 動作確認結果
| 項目 | 結果 |
|------|------|
| 国語→参考書選択画面 | ✅ jp_テスト参考書表示 |
| クイズ実行 | ✅ 最後まで完走 |
| usage_count | ✅ 問題選択後に増加確認 |

#### 現在のシート構成
```
Users          - ユーザー管理
Answers        - 回答履歴
Sessions       - セッション管理
jp_テスト参考書 - テスト用（5問）
```
※ Questionsシート（3,095問）は削除済み

---

### 2026-01-02 - Phase 5 参考書ベース機能 実装 ✅

#### GAS API（午前）
| API | 機能 |
|-----|------|
| create_book | 参考書シート作成（usage_count列付き） |
| get_books | 参考書一覧取得（シート名自動認識） |
| get_book_questions | 問題取得（usage_count考慮出題） |

#### 設計決定
- **シート命名規則**: `{教科コード}_{参考書名}`
- **教科コード**: jp, math, sci, soc
- **出題優先度**: usage_countが少ない問題から優先

#### フロントエンド（午後）
- BookSelect画面: 参考書一覧、教科フィルタ
- Quiz修正: book_idパラメータ対応
- Dashboard修正: 教科クリック → /books へ遷移

#### 画面遷移フロー
```
Dashboard → /books?subject=jp → /quiz?book_id=jp_参考書名 → Result
```

---

## v1.0 開発履歴（2026-01-01〜02）

### Phase 4: GAS API連携 ✅
- API通信基盤（services/api.ts）、型定義（types/api.ts）
- 認証コンテキスト（AuthContext）、AuthGuard
- Dashboard/Quiz/Settings: API連携

### Phase 3: ページ実装 ✅
- Dashboard, Quiz, Result, History, Settings の5ページ
- ルーティング設定（react-router-dom）

### Phase 2: UIコンポーネント ✅
- Atoms: Button, Card, Input, ProgressBar, Loading
- Header/Footer: ロゴ、ナビゲーション、ユーザーアイコン
- グラフ: BarChart, DoughnutChart（Chart.js）
- 機能: HeroMessage, SubjectCard, DashboardMetrics

### Phase 1: プロジェクト基盤 ✅
- Vite + React 19 + TypeScript 5
- SCSS Modules + デザイントークン
- ディレクトリ構造、@/パスエイリアス

---

## v0.5 MVP 開発履歴（2025-12-29〜31）- アーカイブ

### 主要マイルストーン
| 日付 | 内容 |
|------|------|
| 12/29 18:30 | MVP完成・動作確認成功 |
| 12/29 22:56 | 問題インポート機能実装 |
| 12/30 00:10 | 時事問題107問インポート |
| 12/30 02:00 | 問題生成失敗（モデル選定ミス）→ やり直し |
| 12/30 10:30 | 3,095問生成・インポート完了 |
| 12/31 00:00 | 本番ユーザー2名作成 |
| 12/31 08:40 | パスワード先頭0消失バグ修正 |
| 12/31 09:00 | 広報ドキュメント作成 |
| 01/01 19:00 | UI設計書・モックアップ追加 |
| 01/01 19:20 | v0.5バックアップ作成 |

### 問題生成の教訓（12/30）
- **失敗**: `gemini-2.0-flash-lite` で3,060問生成 → 品質不良で全破棄
- **成功**: `gemini-3-flash-preview` で3,095問再生成
- **教訓**: 生成タスクには最新・最強モデルを使う

### 技術的な学び
- GAS timeout対策: import_questions.py のtimeoutを300秒に延長
- パスワード保存: `setNumberFormat('@')` で文字列形式を強制
- 問題インポート: 40ファイル個別インポートで成功

---

## 過去の教訓（v1-v3からの学び）

1. **LLM都度生成は遅すぎた** → 事前生成済みデータを使用
2. **複雑にしすぎた** → シンプル最優先
3. **完璧を求めすぎた** → 最小限から始める
4. **モデル選定を軽視** → 最新・最強モデルを使う

---

**最終更新**: 2026-01-03 11:00
